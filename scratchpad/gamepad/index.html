<html>
	<head>
		<title>Gamepad API</title>
		<link rel="stylesheet" type="text/css" href="index.css">
	</head>
	<body onload="go()">
		<h1>Gamepad API</h1>
		<script type="text/javascript">
			let controllers = {};

			function go() {
				window.addEventListener("gamepadconnected", connect);
				window.addEventListener("gamepaddisconnected", disconnect);
			}

			function connect(e) {
				add(e.gamepad);
			}

			function disconnect(e) {
				remove(e.gamepad);
			}

			function update(e) {
				scan();

				Object.keys(controllers).forEach(index => {
					let controller = controllers[index];
					let id = "pre" + controller.index;
					let pre = document.getElementById(id);
					let result = {};

					controller.buttons.forEach((button, index) => {
						let name = "button " + index;

						result[name] = button.value;
					});

					controller.axes.forEach((axis, index) => {
						let name = "axis " + index;

						result[name] = axis.toFixed(3);
					});

					pre.innerHTML = JSON.stringify(result, null, 2);
				});

				requestAnimationFrame(update);
			}

			function scan() {
				var gamepads = navigator.getGamepads();

				gamepads.forEach(gamepad => {
					if (gamepad) {
						if (gamepad.index in controllers) {
							controllers[gamepad.index] = gamepad;
						}
						else {
							add(gamepad);
						}
					}
				});
			}

			function add(gamepad) {
				controllers[gamepad.index] = gamepad;

				var div = document.createElement("div");
				div.setAttribute("id", "controller" + gamepad.index);

				var header = document.createElement("h1");
				var headerText = document.createTextNode("gamepad " + gamepad.id);
				header.appendChild(headerText);
				div.appendChild(header);

				var pre = document.createElement("pre");
				pre.setAttribute("id", "pre" + gamepad.index);
				div.appendChild(pre);

				document.body.appendChild(div);

				requestAnimationFrame(update);
			}

			function remove(gamepad) {
				console.log("removing %s", gamepad.id);
				delete controllers[gamepad.index];

				var div = document.getElementById("controller" + gamepad.index);
				document.body.removeChild(div);
			}
		</script>
	</body>
</html>
